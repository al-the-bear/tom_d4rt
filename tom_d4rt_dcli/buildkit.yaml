# Tom Build Configuration for tom_d4rt_dcli

versioner:
  variable-prefix: dcli

cleanup:
  - '*.g.dart'
  - '*.b.dart'

d4rtgen:
  name: tom_d4rt_dcli
  helpersImport: package:tom_d4rt/tom_d4rt.dart
  generateBarrel: true
  barrelPath: lib/d4rt_bridges.b.dart
  generateDartscript: true
  dartscriptPath: lib/dartscript.b.dart
  registrationClass: TomD4rtDcliBridge
  generateTestRunner: true
  testRunnerPath: bin/d4rtrun.b.dart
  modules:
    - name: cli_api
      barrelFiles:
        - package:tom_d4rt_dcli/tom_d4rt_cli_api.dart
      barrelImport: package:tom_d4rt_dcli/tom_d4rt_cli_api.dart
      outputPath: lib/src/bridges/cli_api_bridges.b.dart
      followAllReExports: false
    - name: tom_vscode_scripting_api
      barrelFiles:
        - package:tom_vscode_scripting_api/script_globals.dart
      barrelImport: package:tom_vscode_scripting_api/script_globals.dart
      outputPath: lib/src/bridges/tom_vscode_scripting_api_bridges.b.dart
      excludePatterns:
        - "**/*_bridge.dart"
        - "**/*_generated.dart"
    - name: dcli
      barrelFiles:
        - package:dcli/dcli.dart
        - package:dcli_core/dcli_core.dart
      barrelImport: package:dcli/dcli.dart
      outputPath: lib/src/bridges/dcli_bridges.b.dart
      followAllReExports: true
      skipReExports:
        - crypto
      excludePatterns:
        - "**/*_bridge.dart"
        - "**/*_generated.dart"
      excludeSourcePatterns:
        # Column class uses ColumnComparator which is not exported from barrel
        - "package:dcli/src/util/file_sort.dart#Column"
        # Extensions on types not exported from barrel (Platform is from dart:io, Digest from crypto)
        - "package:dcli_core/src/util/platform.dart#PlatformEx"
        - "package:dcli/src/util/digest_helper.dart#DigestHelper"
        # Settings and utilities
        - "package:dcli_core/src/settings.dart#Settings,verbose"
        - "package:dcli_core/src/util/file.dart#FileNotFoundException,NotAFileException,withOpenFile,symlink,deleteSymlink,resolveSymLink,stat,createTempFilename,createTempFile,fileLength,calculateHash,withTempFileAsync"
        - "package:dcli_core/src/util/limited_stream_controller.dart"
        # Functions - exclude internal dcli_core functions and classes not re-exported from dcli barrel
        - "package:dcli_core/src/functions/backup.dart#backupFile,restoreFile,withFileProtectionAsync"
        - "package:dcli_core/src/functions/cat.dart#cat,Cat"
        - "package:dcli_core/src/functions/copy.dart#copy"
        - "package:dcli_core/src/functions/copy_tree.dart#copyTree,CopyTreeException"
        - "package:dcli_core/src/functions/create_dir.dart#createDir,createTempDir,withTempDirAsync"
        - "package:dcli_core/src/functions/dcli_function.dart"
        - "package:dcli_core/src/functions/delete.dart#delete"
        - "package:dcli_core/src/functions/delete_dir.dart#deleteDir"
        - "package:dcli_core/src/functions/env.dart#withEnvironment"
        - "package:dcli_core/src/functions/find.dart#find"
        - "package:dcli_core/src/functions/find_async.dart"
        - "package:dcli_core/src/functions/head.dart#head,HeadException"
        - "package:dcli_core/src/functions/is.dart#isFile,isDirectory,isLink,exists,lastModified,setLastModifed,isEmpty"
        - "package:dcli_core/src/functions/move.dart#move"
        - "package:dcli_core/src/functions/move_dir.dart#moveDir"
        - "package:dcli_core/src/functions/move_tree.dart#moveTree"
        - "package:dcli_core/src/functions/tail.dart#tail,TailException"
        - "package:dcli_core/src/functions/touch.dart#touch,TouchException"
        - "package:dcli_core/src/functions/which.dart#which"
    - name: tom_chattools
      barrelFiles:
        - package:tom_chattools/tom_chattools.dart
      barrelImport: package:tom_chattools/tom_chattools.dart
      outputPath: lib/src/bridges/tom_chattools_bridges.b.dart
      followAllReExports: false
      excludePatterns:
        - "**/*_bridge.dart"
        - "**/*_generated.dart"

compiler:
  compiles:
    # macOS ARM64 - compile for self + all Linux targets
    - commandline:
        - mkdir -p $HOME/.tom/bin/${target-platform-vs}
        - dart compile exe ${file} --target-os=${target-os} -o $HOME/.tom/bin/${target-platform-vs}/${file.name}
      files: bin/dcli.dart
      targets: [darwin-arm64, linux-x64, linux-arm64, linux-armhf]
      platforms: [darwin-arm64]
    
    # Other platforms - compile for self only
    - commandline:
        - mkdir -p $HOME/.tom/bin/${target-platform-vs}
        - dart compile exe ${file} -o $HOME/.tom/bin/${target-platform-vs}/${file.name}
      files: bin/dcli.dart
      platforms: [darwin-x64, linux-*, win32-*]

  postcompile:
    # Make binaries executable on Unix-like systems
    - commandline:
        - chmod -R +x $HOME/.tom/bin/${current-platform-vs}/
      platforms: [macos, linux]
