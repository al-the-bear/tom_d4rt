# Issue Analysis: tom_d4rt_dcli

**Date:** 2026-02-15  
**Scope:** `xternal/tom_module_d4rt/tom_d4rt_dcli`  
**Test results:** 364 pass, 12 skip, 12 fail  
**Analyzer:** No issues in `lib/` or `test/`  
**Baseline reference:** `doc/baseline_0210_1100.csv` — all 12 failures and 12 skips are regressions (were `OK/OK` in baseline)

---

## Overview

| ID | Description | Status | Category |
|----|-------------|--------|----------|
| [DCLI-GEN-001](#dcli-gen-001-missing-global-functions-lastmodified-setlastmodifed-symlink) | Missing global functions: lastModified, setLastModifed, symlink | FAILS | Bridge generation gap |
| [DCLI-GEN-002](#dcli-gen-002-missing-find-class-bridge) | Missing Find class bridge (static const members) | FAILS | Bridge generation gap |
| ~~DCLI-LOCK-001~~ | ~~NamedLock.withLock throws UnsupportedError in dcli 8.4.2~~ | REMOVED | Deprecated method — tests updated to expect failure |
| [DCLI-API-001](#dcli-api-001-expanddefine-test-uses-wrong-prefix) | expandDefine test uses wrong prefix (`$` vs `@`) | FAILS | Test failure |
| [DCLI-VSCODE-001](#dcli-vscode-001-12-vs-code-bridge-tests-skipped) | 12 VS Code bridge tests — fixed (import path + constructor args) | RESOLVED | Test infrastructure |

---

## Detailed Analysis

---

### DCLI-GEN-001: Missing global functions: lastModified, setLastModifed, symlink

**Tests affected (5):**

| # | Test | File | Error |
|---|------|------|-------|
| 1 | DCli Global Functions - File Operations > lastModified() returns DateTime | `test/cli_api_bridges_test.dart:417` | `Undefined variable: lastModified` |
| 2 | DCli Global Functions - File Operations > setLastModifed() updates file timestamp | `test/cli_api_bridges_test.dart:429` | `Undefined variable: setLastModifed` |
| 3 | DCli Global Functions - Symlinks > symlink() creates symbolic link | `test/cli_api_bridges_test.dart:829` | `Undefined variable: symlink` |
| 4 | DCli Global Functions - Symlinks > symlink() link points to target | `test/cli_api_bridges_test.dart:841` | `Undefined variable: symlink` |
| 5 | Integration - Complex File Operations > symlink operations chain | `test/cli_api_bridges_test.dart:2513` | `Undefined variable: symlink` |

**Baseline status:** All 5 were `OK/OK` in baseline_0210_1100.csv (lines 193, 199, 257, 258, 362)

#### Reproduction Context

Scripts executed via `BridgeTestContext` call these as top-level functions:
```dart
var dt = lastModified('/path/to/file');
setLastModifed('/path/to/file', DateTime(2025, 1, 1));
symlink('/target', '/link');
```

The D4rt interpreter says `Undefined variable` because these functions are not registered as global functions in the bridge.

#### Root Cause Analysis

The auto-generated bridge file `lib/src/bridges/dcli_bridges.b.dart` (regenerated 2026-02-15) does **not** include these three global functions in `globalFunctions()`:

- `lastModified(String path)` — defined in `package:dcli_core/src/functions/is.dart:79`
- `setLastModifed(String path, DateTime lastModified)` — defined in `package:dcli_core/src/functions/is.dart:97`
- `symlink(String existingPath, String linkPath)` — defined in `package:dcli/src/util/symlink.dart:26`

Other functions from the **same source files** ARE included:
- From `is.dart`: `isFile`, `isDirectory`, `isLink`, `exists`, `isEmpty` ✓
- From `dcli/src/util/file_sync.dart`: `createSymLink`, `deleteSymlink`, `resolveSymLink` ✓

The old hand-written bridge (`lib/src/d4rt_library_bridges/package_dcli_bridges.b.dart`) had all three functions at lines 368-377 and 555-559, but the old bridge system is no longer loaded — `dartscript.b.dart` only registers the new auto-generated bridges.

The bridge generator (`tom_d4rt_generator/lib/src/bridge_generator.dart`) failed to collect these functions from the dcli/dcli_core package exports. This is a bridge generator analysis gap — it fails to discover some top-level functions that are re-exported through barrel files.

#### Solution Strategy

**Fix in the bridge generator** (`tom_d4rt_generator`):
- Investigate why `lastModified`, `setLastModifed`, and `symlink` are not discovered during the barrel export crawl
- `lastModified` and `setLastModifed` are in the same file (`is.dart`) as `isFile`, `isDirectory` etc. which ARE discovered — suggesting the generator may have a limit on how many functions it collects per file, or it may be filtering based on some naming heuristic
- `symlink` is exported from `package:dcli/dcli.dart` through `src/util/symlink.dart` — a separate file from `file_sync.dart` where `createSymLink`/`deleteSymlink`/`resolveSymLink` are defined
- The fix must be a general solution in the function discovery logic, not hardcoded patches

**Applicable guidelines:**
- `_copilot_guidelines/d4rt/testing_d4rt_bridges.md` for bridge testing patterns
- Bridge generator architecture in `tom_d4rt_generator`

---

### DCLI-GEN-002: Missing Find class bridge

**Tests affected (3):**

| # | Test | File | Error |
|---|------|------|-------|
| 1 | Enums - DCli Enums > Find.file is available | `test/cli_api_bridges_test.dart:2300` | `Undefined variable: Find` |
| 2 | Enums - DCli Enums > Find.directory is available | `test/cli_api_bridges_test.dart:2309` | `Undefined variable: Find` |
| 3 | Enums - DCli Enums > Find.link is available | `test/cli_api_bridges_test.dart:2318` | `Undefined variable: Find` |

**Baseline status:** All 3 were `OK/OK` in baseline_0210_1100.csv (lines 349-351)

#### Reproduction Context

Scripts access `Find` static constants:
```dart
print(Find.file);
print(Find.directory);
print(Find.link);
```

The D4rt interpreter says `Undefined variable: Find` because the `Find` class is not registered as a bridged class or enum.

#### Root Cause Analysis

`Find` is a **class** (not an enum) defined in `package:dcli_core/src/functions/find.dart:116`:
```dart
class Find extends DCliFunction {
  static const FileSystemEntityType file = FileSystemEntityType.file;
  static const FileSystemEntityType directory = FileSystemEntityType.directory;
  static const FileSystemEntityType link = FileSystemEntityType.link;
  // ...
}
```

The auto-generated `dcli_bridges.b.dart` includes:
- ✓ `FindItem` (class from same file)
- ✓ `FindProgress` (class)
- ✓ `find()` (global function that uses `Find.file` as default)
- ✗ `Find` (class with static constants) — **missing**

The registered enums are: `TableAlignment`, `TerminalClearMode`, `FetchMethod`, `FetchStatus`, `Interval`, `SortDirection`. `Find` is not among them because it's a class, not an enum.

The old hand-written bridge (`lib/src/d4rt_library_bridges/package_dcli_core_bridges.b.dart:1097-1109`) had a custom `BridgedClass` for `Find` with static getters returning `FileSystemEntityType` values.

The bridge generator likely skipped `Find` because it extends `DCliFunction` and the generator may filter out abstract/utility base classes, or because its primary role is as a namespace for static constants rather than an instantiable class.

#### Solution Strategy

**Fix in the bridge generator** (`tom_d4rt_generator`):
- Classes with only static const members should still be bridged — they serve as enum-like namespaces
- The generator should detect the pattern: class with `static const` members of a common type + no public constructors → generate static getters
- `Find` has public instance methods too (`_find`, etc.) but scripts only use it for `Find.file`, `Find.directory`, `Find.link`
- The generated bridge should include a `BridgedClass` with static getters for the constants

**Alternative immediate workaround** (in tom_d4rt_dcli, not in generator):
- Add a custom `Find` bridge in `dcli_bridges.b.dart` via the `custom_protected/` blocks (if the generated file supports custom sections)
- This is a workaround, the general fix should be in the generator

---

### DCLI-LOCK-001: NamedLock.withLock — REMOVED

**Status:** REMOVED (2026-02-15) — `withLock` is deprecated in dcli 8.4.2 and intentionally throws `UnsupportedError`. Tests updated to expect the failure.

---

### DCLI-API-001: expandDefine test uses wrong prefix

**Tests affected (1):**

| # | Test | File | Error |
|---|------|------|-------|
| 1 | CLI API Controller - Core Methods > defines > expandDefine parses define invocation | `test/cli_api_comprehensive_test.dart:325` | Expected: `'expanded'`, Actual: `null` |

**Baseline status:** `X/OK` in baseline_0210_1100.csv (line 2) — **pre-existing failure** since before baseline

#### Reproduction Context

```dart
test('expandDefine parses define invocation', () {
  ctx.controller.define('test', 'expanded');
  final result = ctx.controller.expandDefine('\$test');  // passes "$test"
  expect(result, 'expanded');
});
```

`expandDefine` returns `null` because input `$test` doesn't match the expected format.

#### Root Cause Analysis

The `expandDefine` implementation in `lib/src/api/cli_controller.dart:533`:
```dart
String? expandDefine(String input) {
  if (!input.startsWith('@')) return null;  // ← expects '@' prefix
  final parts = input.substring(1).split(RegExp(r'\s+'));
  if (parts.isEmpty) return null;
  final name = parts[0];
  final args = parts.length > 1 ? parts.sublist(1) : <String>[];
  return invokeDefine(name, args);
}
```

The method expects input starting with `@` (e.g., `@test`), but the test passes `$test`. The API documentation also states:
```dart
/// Expand a define invocation string (e.g., "@greet World").
```

This is a **test bug** — either:
1. The define prefix was changed from `$` to `@` at some point and the test wasn't updated, OR
2. The test was always wrong

Since the baseline already shows `X/OK`, this was failing before the current session's changes.

#### Solution Strategy

**Fix the test** (justified — the test is using the wrong API convention):
- Change `'\$test'` to `'@test'` in the test at line 327:
  ```dart
  final result = ctx.controller.expandDefine('@test');
  ```
- This aligns with the API documentation and the implementation
- No code change needed in `cli_controller.dart` — the implementation is correct

---

### DCLI-VSCODE-001: 12 VS Code bridge tests — RESOLVED

**Status:** RESOLVED (2026-02-15)

**Fixes applied:**
1. Import path in `exec()` method changed from `package:tom_vscode_scripting_api/tom_vscode_scripting_api.dart` to `package:tom_vscode_scripting_api/script_globals.dart` (matching the barrel import in buildkit.yaml)
2. Test scripts fixed to match actual constructor signatures:
   - `VSCodeUri`: Added missing required `fsPath` parameter
   - `Position`: Changed from named (`line:`, `character:`) to positional params
   - `Range`: Changed from named (`start:`, `end:`) to positional params
   - `Selection`: Changed from named to positional params, added missing `isReversed`

**Result:** All 25 tests pass (13 native bridge tests + 12 D4rt script execution tests)

---

## Summary of Root Causes

| Category | Count | Root Cause | Fix Location |
|----------|-------|------------|--------------|
| Bridge generation gap | 8 tests | Generator misses some global functions and the `Find` class | `tom_d4rt_generator` |
| ~~Native API deprecation~~ | ~~3 tests~~ | ~~dcli 8.4.2 deprecated `NamedLock.withLock()`~~ | Tests updated to expect failure (REMOVED) |
| Test bug (pre-existing) | 1 test | Wrong prefix `$` vs `@` in expandDefine test | Test file |
| Test infrastructure | 12 tests | Import path mismatch + wrong constructor args in test scripts | Test file (RESOLVED) |

**Priority order:**
1. **DCLI-GEN-001 + DCLI-GEN-002** — Bridge generation gaps (generator fix needed, blocks 8 tests)
2. ~~**DCLI-LOCK-001** — NamedLock.withLock deprecated~~ **REMOVED**
3. **DCLI-API-001** — Test prefix fix (trivial, unblocks 1 test)
4. ~~**DCLI-VSCODE-001** — VS Code test infrastructure~~ **RESOLVED**
