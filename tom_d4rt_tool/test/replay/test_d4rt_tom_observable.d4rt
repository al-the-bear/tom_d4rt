# D4rt Test Suite - Part 4: Custom Classes and Interfaces
# Run with: d4rt -run-replay test_d4rt_tom_observable.d4rt -test
# Tests defining custom classes that implement patterns


# =============================================================================
# Test: Observer Pattern (5 tests)
# =============================================================================

.start-define
class SimpleObserver {
  int notifyCount = 0;
  dynamic lastValue;
  
  void notify(dynamic value) {
    notifyCount++;
    lastValue = value;
  }
}
.end

var observer = SimpleObserver();
verifyNotNull(observer, 'Observer created');
verifyEquals(observer.notifyCount, 0, 'Initial count is 0');

observer.notify('test1');
verifyEquals(observer.notifyCount, 1, 'Count after first notify');
verifyEquals(observer.lastValue, 'test1', 'Last value set');

# =============================================================================
# Test: Multiple Notifications (5 tests)
# =============================================================================

observer.notify('test2');
verifyEquals(observer.notifyCount, 2, 'Count after second notify');

observer.notify('test3');
verifyEquals(observer.notifyCount, 3, 'Count after third notify');
verifyEquals(observer.lastValue, 'test3', 'Last value updated');

var observer2 = SimpleObserver();
verifyEquals(observer2.notifyCount, 0, 'New observer starts at 0');
verifyEquals(observer2.lastValue, null, 'New observer has null value');

# =============================================================================
# Test: Disposable Pattern (5 tests)
# =============================================================================

.start-define
class SimpleDisposable {
  bool _disposed = false;
  
  bool get isDisposed => _disposed;
  
  void dispose() {
    _disposed = true;
  }
}
.end

var disposable = SimpleDisposable();
verifyEquals(disposable.isDisposed, false, 'Not disposed initially');

disposable.dispose();
verifyEquals(disposable.isDisposed, true, 'Disposed after dispose()');

var d2 = SimpleDisposable();
verifyEquals(d2.isDisposed, false, 'Second disposable fresh');

d2.dispose();
verifyEquals(d2.isDisposed, true, 'Second disposed');

var d3 = SimpleDisposable();
verifyEquals(d3.isDisposed, false, 'Third disposable fresh');

# =============================================================================
# Test: Event Emitter Pattern (5 tests)
# =============================================================================

.start-define
class EventEmitter {
  final List<Function> _listeners = [];
  
  void addListener(Function listener) {
    _listeners.add(listener);
  }
  
  void removeListener(Function listener) {
    _listeners.remove(listener);
  }
  
  int get listenerCount => _listeners.length;
}
.end

var emitter = EventEmitter();
verifyEquals(emitter.listenerCount, 0, 'No listeners initially');

emitter.addListener(() {});
verifyEquals(emitter.listenerCount, 1, 'One listener added');

emitter.addListener(() {});
verifyEquals(emitter.listenerCount, 2, 'Two listeners');

var emitter2 = EventEmitter();
verifyEquals(emitter2.listenerCount, 0, 'New emitter has no listeners');
verifyNotNull(emitter2, 'Emitter not null');

# =============================================================================
# Summary
# =============================================================================

testSummary();
