# Tom Build Configuration for tom_dartscript_bridges

versioner:
  output: lib/src/cli/version.versioner.dart

cleanup:
  - 'lib/src/cli/version.versioner.dart'
  - 'lib/src/d4rt_library_bridges/bridges_trigger.g.dart'

d4rtgen:
  name: tom_dartscript_bridges
  helpersImport: package:tom_d4rt/tom_d4rt.dart
  generateBarrel: true
  barrelPath: lib/d4rt_bridges.b.dart
  generateDartscript: true
  dartscriptPath: lib/dartscript.b.dart
  registrationClass: TomDartscriptBridges
  generateTestRunner: true
  testRunnerPath: bin/d4rtrun.b.dart
  importedBridges:
    - import: package:tom_d4rt_dcli/dartscript.b.dart
      class: TomD4rtDcliBridge
  modules:
    - name: tom_basics
      barrelImport: package:tom_basics/tom_basics.dart
      outputPath: lib/src/tom_basics/tom_basics_bridges.b.dart
    - name: tom_reflection
      barrelImport: package:tom_reflection/tom_reflection.dart
      outputPath: lib/src/tom_reflection/tom_reflection_bridges.b.dart
    - name: tom_process_monitor
      barrelImport: package:tom_process_monitor/tom_process_monitor.dart
      outputPath: lib/src/tom_process_monitor/tom_process_monitor_bridges.b.dart
    - name: tom_core_kernel
      barrelImport: package:tom_core_kernel/tom_core_kernel.dart
      outputPath: lib/src/tom_core_kernel/tom_core_kernel_bridges.b.dart
      skipReExports:
        - package:tom_reflection/tom_reflection.dart
      excludeVariables:
        - data
        - memberSymbolMap
    - name: tom_build
      barrelImport: package:tom_build/tom_build.dart
      outputPath: lib/src/tom_build/tom_build_bridges.b.dart
      skipReExports:
        - package:tom_core_kernel/tom_core_kernel.dart
    # Re-enabled to test bug fixes:
    - name: tom_core_server
      barrelImport: package:tom_core_server/tom_core_server.dart
      outputPath: lib/src/tom_core_server/tom_core_server_bridges.b.dart
      skipReExports:
        - package:tom_core_kernel/tom_core_kernel.dart
      excludeVariables:
        - data
        - memberSymbolMap
    - name: tom_dist_ledger
      barrelImport: package:tom_dist_ledger/tom_dist_ledger.dart
      outputPath: lib/src/tom_dist_ledger/tom_dist_ledger_bridges.b.dart

compiler:
  compiles:
    # macOS ARM64 - compile for self + all Linux targets
    - commandline:
        - mkdir -p $HOME/.tom/bin/${target-platform-vs}
        - dart compile exe ${file} --target-os=${target-os} -o $HOME/.tom/bin/${target-platform-vs}/${file.name}
      files: bin/d4rt.dart
      targets: [darwin-arm64, linux-x64, linux-arm64, linux-armhf]
      platforms: [darwin-arm64]
    
    # Other platforms - compile for self only
    - commandline:
        - mkdir -p $HOME/.tom/bin/${target-platform-vs}
        - dart compile exe ${file} -o $HOME/.tom/bin/${target-platform-vs}/${file.name}
      files: bin/d4rt.dart
      platforms: [darwin-x64, linux-*, win32-*]

  postcompile:
    # Make binaries executable on Unix-like systems
    - commandline:
        - chmod -R +x $HOME/.tom/bin/${current-platform-vs}/
      platforms: [macos, linux]
